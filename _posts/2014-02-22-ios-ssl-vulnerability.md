---
layout: post
title: Typo in Apple's SSL implementation causes uniform failure to validate key exchange
comments: true
permalink: ios-ssl-vulnerability.html
---


Tonight my friend Chad Brubaker[1] pointed me at an interesting problem. Apple has been rolling out an iOS update to patch an critical flaw in their SSL implementation.

His challenge to me: what is the problem with the SSL stack? (He'd already figured it out I think.)

Unfortunately, people have been really tight-lipped about it. One researcher [remarked](http://www.reuters.com/article/2014/02/22/apple-flaw-idUSL2N0LR07920140222) that "It's as bad as you could imagine, that's all I can say." So far no one has stepped forward to explain. What we did know is that the vulnerability makes it very easy to execute man-in-the-middle attacks on iOS users.

It turns out to be a typo in the function `SSLVerifySignedServerKeyExchange` in [sslKeyExchange.c](http://opensource.apple.com/source/Security/Security-55471/libsecurity_ssl/lib/sslKeyExchange.c?txt). Specifically, near the bottom of the function we see the following code:

```c
if ((err = SSLHashSHA1.update(&hashCtx, &serverRandom)) != 0)
    goto fail;
if ((err = SSLHashSHA1.update(&hashCtx, &signedParams)) != 0)
    goto fail;
    goto fail;
if ((err = SSLHashSHA1.final(&hashCtx, &hashOut)) != 0)
    goto fail;

err = sslRawVerify(ctx,
                   ctx->peerPubKey,
                   dataToSign,				/* plaintext */
                   dataToSignLen,			/* plaintext length */
                   signature,
                   signatureLen);
```

Notice anything weird? That second `if` has two `goto fail;` statements underneath it. So:

* The function `SSLVerifySignedServerKeyExchange` is supposed to verify the key exchange.
* But, the second `goto fail` causes us to *always* jump to the `fail` label, no matter what. Even if the SHA1 update worked.
* In particular, this means that we *always* bypass the call to `sslRawVerify`.
* And therefore, the error code `err` doesn't get set in the event that the verification fails.
* As you can imagine, this is a pretty bad flaw.

This has got to be the bug of the year. Needless to say, I recommend you upgrade your Apple products quickly.


[1] Chad works at Google. Fun fact about Chad: due to his background as a security researcher, he has developed pretty intense trust issues, and hence works on the only Google team that consists entirely of ponies. He is also one of the smartest people I've ever met.